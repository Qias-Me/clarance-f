<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section 11 Data Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-header {
            background: #2563eb;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
        }
        .test-step {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #e5e7eb;
            background: #f9fafb;
        }
        .test-step.success {
            border-left-color: #10b981;
            background: #ecfdf5;
        }
        .test-step.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .test-step.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .console-output {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .field-test {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 4px;
        }
        .field-test input {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧪 Section 11 Data Flow Validation Test</h1>
            <p>Testing complete data flow: Form Input → Context Update → IndexedDB Persistence → PDF Generation</p>
        </div>

        <div class="test-step">
            <h3>📋 Test Instructions</h3>
            <p>1. Open browser console (F12) to see detailed logs</p>
            <p>2. Navigate to Section 11 in the SF-86 form</p>
            <p>3. Run each test step below</p>
            <p>4. Verify that field values persist correctly</p>
        </div>

        <div class="test-step">
            <h3>🔗 Quick Navigation</h3>
            <button onclick="navigateToSection11()">Go to Section 11</button>
            <button onclick="navigateToStartForm()">Go to Start Form</button>
            <button onclick="clearConsole()">Clear Console</button>
        </div>

        <div class="test-step">
            <h3>🔍 Step 1: Field Mapping Verification</h3>
            <button onclick="testFieldMapping()">Test Field Mapping</button>
            <div id="fieldMappingResults" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-step">
            <h3>🏠 Step 2: Entry Creation Test</h3>
            <button onclick="testEntryCreation()">Test All 4 Entries</button>
            <div id="entryCreationResults" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-step">
            <h3>📝 Step 3: Form Input Simulation</h3>
            <div class="field-test">
                <input type="text" id="testStreetAddress" placeholder="Street Address" value="123 Test Street">
                <input type="text" id="testCity" placeholder="City" value="Test City">
                <input type="email" id="testEmail" placeholder="Contact Email" value="test@example.com">
            </div>
            <button onclick="simulateFormInput()">Simulate Form Input</button>
            <div id="formInputResults" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-step">
            <h3>💾 Step 4: Data Persistence Test</h3>
            <button onclick="testDataPersistence()">Test IndexedDB Persistence</button>
            <div id="persistenceResults" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-step">
            <h3>📄 Step 5: PDF Generation Test</h3>
            <button onclick="testPDFGeneration()">Test PDF Field Mapping</button>
            <div id="pdfResults" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-step">
            <h3>🔄 Step 6: Complete Data Flow Test</h3>
            <button onclick="runCompleteDataFlowTest()">Run Complete Test</button>
            <div id="completeTestResults" class="console-output" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Utility functions
        function log(message, elementId) {
            console.log(message);
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                element.textContent += message + '\n';
            }
        }

        function clearResults(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = '';
                element.style.display = 'none';
            }
        }

        function clearConsole() {
            console.clear();
            document.querySelectorAll('.console-output').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
        }

        // Navigation functions
        function navigateToSection11() {
            window.location.href = '/form/section-11';
        }

        function navigateToStartForm() {
            window.location.href = '/startform';
        }

        // Test functions
        function testFieldMapping() {
            clearResults('fieldMappingResults');
            log('🔍 Testing Section 11 Field Mapping...', 'fieldMappingResults');
            
            try {
                // Test if field mapping utilities are available
                if (typeof window.debugAllEntries === 'function') {
                    log('✅ Field mapping utilities found', 'fieldMappingResults');
                    window.debugAllEntries();
                } else {
                    log('⚠️ Field mapping utilities not available in window scope', 'fieldMappingResults');
                    log('💡 Try running this test from the Section 11 page', 'fieldMappingResults');
                }
                
                // Test entry patterns
                const patterns = ['Section11[0]', 'Section11-2[0]', 'Section11-3[0]', 'Section11-4[0]'];
                patterns.forEach((pattern, index) => {
                    log(`Entry ${index + 1}: ${pattern}`, 'fieldMappingResults');
                });
                
            } catch (error) {
                log(`❌ Field mapping test failed: ${error.message}`, 'fieldMappingResults');
            }
        }

        function testEntryCreation() {
            clearResults('entryCreationResults');
            log('🏠 Testing Entry Creation for All 4 Entries...', 'entryCreationResults');
            
            try {
                // This test requires access to the Section 11 context
                log('💡 This test requires being on the Section 11 page', 'entryCreationResults');
                log('📝 Manual verification steps:', 'entryCreationResults');
                log('1. Navigate to Section 11', 'entryCreationResults');
                log('2. Add multiple residence entries', 'entryCreationResults');
                log('3. Verify each entry has proper field mapping', 'entryCreationResults');
                log('4. Check console for field creation logs', 'entryCreationResults');
                
            } catch (error) {
                log(`❌ Entry creation test failed: ${error.message}`, 'entryCreationResults');
            }
        }

        function simulateFormInput() {
            clearResults('formInputResults');
            log('📝 Simulating Form Input...', 'formInputResults');
            
            const streetAddress = document.getElementById('testStreetAddress').value;
            const city = document.getElementById('testCity').value;
            const email = document.getElementById('testEmail').value;
            
            log(`Test Data:`, 'formInputResults');
            log(`  Street: ${streetAddress}`, 'formInputResults');
            log(`  City: ${city}`, 'formInputResults');
            log(`  Email: ${email}`, 'formInputResults');
            
            // Instructions for manual testing
            log('💡 Manual testing steps:', 'formInputResults');
            log('1. Go to Section 11 form', 'formInputResults');
            log('2. Enter the test data above', 'formInputResults');
            log('3. Check console for updateFieldValue logs', 'formInputResults');
            log('4. Verify data appears in form fields', 'formInputResults');
        }

        function testDataPersistence() {
            clearResults('persistenceResults');
            log('💾 Testing Data Persistence...', 'persistenceResults');
            
            try {
                // Check if IndexedDB is available
                if ('indexedDB' in window) {
                    log('✅ IndexedDB is available', 'persistenceResults');
                    
                    // Test IndexedDB access
                    const request = indexedDB.open('SF86FormData', 1);
                    request.onsuccess = function(event) {
                        log('✅ IndexedDB connection successful', 'persistenceResults');
                        const db = event.target.result;
                        log(`Database version: ${db.version}`, 'persistenceResults');
                        log(`Object stores: ${Array.from(db.objectStoreNames).join(', ')}`, 'persistenceResults');
                    };
                    request.onerror = function(event) {
                        log(`❌ IndexedDB connection failed: ${event.target.error}`, 'persistenceResults');
                    };
                } else {
                    log('❌ IndexedDB not available', 'persistenceResults');
                }
                
                log('💡 Manual persistence testing:', 'persistenceResults');
                log('1. Fill out Section 11 form', 'persistenceResults');
                log('2. Click Save button', 'persistenceResults');
                log('3. Refresh page', 'persistenceResults');
                log('4. Verify data is restored', 'persistenceResults');
                
            } catch (error) {
                log(`❌ Persistence test failed: ${error.message}`, 'persistenceResults');
            }
        }

        function testPDFGeneration() {
            clearResults('pdfResults');
            log('📄 Testing PDF Generation...', 'pdfResults');
            
            log('💡 PDF generation testing steps:', 'pdfResults');
            log('1. Complete Section 11 form', 'pdfResults');
            log('2. Navigate to PDF generation page', 'pdfResults');
            log('3. Generate PDF', 'pdfResults');
            log('4. Verify Section 11 fields appear in PDF', 'pdfResults');
            log('5. Check field IDs match sections-references', 'pdfResults');
            
            // Test field ID patterns
            const fieldPatterns = [
                'form1[0].Section11[0].TextField11[3]',      // Entry 1 Street
                'form1[0].Section11-2[0].TextField11[3]',    // Entry 2 Street  
                'form1[0].Section11-3[0].TextField11[3]',    // Entry 3 Street
                'form1[0].Section11-4[0].TextField11[3]'     // Entry 4 Street
            ];
            
            log('Expected PDF field patterns:', 'pdfResults');
            fieldPatterns.forEach((pattern, index) => {
                log(`  Entry ${index + 1}: ${pattern}`, 'pdfResults');
            });
        }

        function runCompleteDataFlowTest() {
            clearResults('completeTestResults');
            log('🔄 Running Complete Data Flow Test...', 'completeTestResults');
            
            log('📋 Complete Test Checklist:', 'completeTestResults');
            log('', 'completeTestResults');
            log('✅ 1. Field Mapping Implementation', 'completeTestResults');
            log('   - Dynamic field mapping utilities created', 'completeTestResults');
            log('   - All 4 entry patterns supported', 'completeTestResults');
            log('   - Sections-references as source of truth', 'completeTestResults');
            log('', 'completeTestResults');
            log('⏳ 2. Form Input Testing (Manual)', 'completeTestResults');
            log('   - Navigate to Section 11', 'completeTestResults');
            log('   - Add multiple residence entries', 'completeTestResults');
            log('   - Fill out form fields', 'completeTestResults');
            log('   - Verify console logs show proper field updates', 'completeTestResults');
            log('', 'completeTestResults');
            log('⏳ 3. Data Persistence Testing (Manual)', 'completeTestResults');
            log('   - Save form data', 'completeTestResults');
            log('   - Refresh page', 'completeTestResults');
            log('   - Verify data restoration', 'completeTestResults');
            log('', 'completeTestResults');
            log('⏳ 4. PDF Generation Testing (Manual)', 'completeTestResults');
            log('   - Generate PDF with Section 11 data', 'completeTestResults');
            log('   - Verify field mapping in PDF', 'completeTestResults');
            log('', 'completeTestResults');
            log('🎯 Next Steps:', 'completeTestResults');
            log('1. Navigate to Section 11: /form/section-11', 'completeTestResults');
            log('2. Test form interactions', 'completeTestResults');
            log('3. Monitor console for field mapping logs', 'completeTestResults');
            log('4. Verify email field persistence issue is resolved', 'completeTestResults');
        }

        // Initialize
        console.log('🧪 Section 11 Data Flow Test Page Loaded');
        console.log('📝 Use the buttons above to run individual tests');
        console.log('🔍 Check console logs for detailed information');
    </script>
</body>
</html>
